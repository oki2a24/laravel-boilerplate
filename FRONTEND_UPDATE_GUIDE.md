### **【指示書】フロントエンドパッケージのバージョンアップ手順**

**目的:**
このリポジトリのフロントエンド依存パッケージ（Vite, Vue.jsなど）を最新版に更新する。

---

### **1. アップデート情報の収集**

1.  **コンテナに入る:**
    *   `docker compose exec --user=app app bash` を実行し、`app`コンテナのシェルに入る。

2.  ** outdatedパッケージの確認:**
    *   コンテナ内で `npm outdated` を実行する。
    *   これにより、現在のバージョン、推奨されるバージョン（Wanted）、そして最新バージョン（Latest）の一覧が表示される。この情報を元に、更新するパッケージとバージョンを決定する。

---

### **2. アップグレード手順**

1.  **事前準備:**
    *   `git diff HEAD` を実行し、`laravel/package.json` に変更がないか確認する。

2.  **パッケージの更新:**
    *   `app`コンテナ内で、`npm install` コマンドを使ってパッケージを一つずつ、または複数まとめて最新バージョンに更新する。
    *   **例:** `npm install vite@latest laravel-vite-plugin@latest`
    *   `devDependencies` に含まれる全てのパッケージを一度に更新する場合は、以下のコマンドを利用できる。
        ```bash
        npm install $(npm outdated | awk 'NR>1 {print $1"@"$4}')
        ```
    *   *注意: `npm update` コマンドは `package.json` のバージョン範囲指定（例: `^3.0.0`）に従うため、メジャーバージョンアップは行われない。メジャーバージョンを更新する場合は `npm install <package>@latest` を使用する。*

3.  **ビルド確認:**
    *   `npm run build` を実行し、本番用のビルドが正常に完了することを確認する。

4.  **フォーマット:**
    *   `npm install` を実行すると `package.json` の依存関係の順序が変わることがあるため、`npx sort-package-json` を実行してアルファベット順にソートする。

5.  **コードと設定の修正:**
    *   メジャーバージョンアップを行った場合、破壊的変更が含まれている可能性がある。
    *   各パッケージの公式サイトやGitHubリポジトリで**リリースノート**や**マイグレーションガイド**を確認し、`vite.config.js`、`.eslintrc.js`、またはVueコンポーネントなどのコードに必要な修正を施す。
    *   **ESLint v9 (Flat Config) に関する注意点:**
        *   このプロジェクトは、ESLint v9で標準となった `eslint.config.js` (Flat Config) 形式を既に使用しています。
        *   そのため、`lint` コマンド実行時に `ESLINT_USE_FLAT_CONFIG=false` を設定する必要は**ありません**。
        *   古い `.eslintrc.js` 形式のプロジェクトで作業する際は、この環境変数の有無に注意してください。
    *   **Prettier v3への移行に関する注意点:**
        *   Prettier v3では `trailingComma` オプションのデフォルト値が `"all"` に変更されました。
        *   もし、この変更によってフォーマットが意図しないものになる場合は、`laravel/.prettierrc` に `"trailingComma": "es5"` または `"trailingComma": "none"` を明示的に設定してください。

---

### **3. 検証**

1.  **静的解析:**
    *   `docker compose exec --user=app app npm run lint` を実行し、リンターのエラーがないことを確認する。
    *   `docker compose exec --user=app app npm run format` を実行し、フォーマッターのエラーがないことを確認する。

2.  **手動テスト:**
    *   フロントエンドパッケージの更新後、必要に応じてコンテナを再起動してください。
    *   `docker compose up -d --build` を実行してコンテナを再構築・再起動するか、既存のコンテナで `make npm-dev` をホスト側で実行して開発サーバーを起動してください。
    *   ブラウザでアプリケーションを開き、ログインページやその他の主要な機能が正常に表示・動作することを確認する。

---

### **4. トラブルシューティング**

*   **ビルドエラー:**
    *   **事象:** `npm run build` でエラーが発生する。
    *   **原因:** パッケージ間の互換性の問題、または設定ファイルの変更が必要な場合が多い。
    *   **解決策:**
        1.  エラーメッセージを詳細に確認する。
        2.  更新したパッケージの公式ドキュメント（特にマイグレーションガイド）を参照し、`vite.config.js` などに必要な変更がされていないか確認する。

*   **依存関係の解決エラー:**
    *   **事象:** `npm install` が `ERESOLVE` などのエラーで失敗する。
    *   **原因:** パッケージ間で要求される依存バージョンが競合している。
    *   **解決策:**
        1.  `laravel/node_modules` ディレクトリと `laravel/package-lock.json` ファイルを削除する。
        2.  再度 `npm install` を実行する。
        3.  それでも解決しない場合は、`--force` や `--legacy-peer-deps` オプションを試すこともできるが、根本的な原因を特定し、`package.json` のバージョン指定を調整することが望ましい。
